<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Common Lisp Chinese Vocabulary Drill.</title>
<!-- 2014-12-04 Thu 15:27 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Riley E." />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Common Lisp Chinese Vocabulary Drill.</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Headers, Variables, Parameters</a>
<ul>
<li><a href="#sec-1-1">1.1. System description</a></li>
<li><a href="#sec-1-2">1.2. System Definition</a></li>
<li><a href="#sec-1-3">1.3. Package Definition</a></li>
<li><a href="#sec-1-4">1.4. Global variables, and setting the package</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Structures</a></li>
<li><a href="#sec-3">3. Comma-separated value import utilities</a>
<ul>
<li><a href="#sec-3-1">3.1. Pre-parsing</a></li>
<li><a href="#sec-3-2">3.2. Separating components</a></li>
<li><a href="#sec-3-3">3.3. Final restructuring of data</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Data-store utility functions</a>
<ul>
<li><a href="#sec-4-1">4.1. element-of-truth</a></li>
<li><a href="#sec-4-2">4.2. gen-ht-key</a></li>
<li><a href="#sec-4-3">4.3. key-exists-p</a></li>
<li><a href="#sec-4-4">4.4. puthash</a></li>
<li><a href="#sec-4-5">4.5. hash-table searching functions</a></li>
</ul>
</li>
<li><a href="#sec-5">5. Entry manipulation</a>
<ul>
<li><a href="#sec-5-1">5.1. add-entry</a></li>
<li><a href="#sec-5-2">5.2. revise-entry</a></li>
<li><a href="#sec-5-3">5.3. append-english</a></li>
<li><a href="#sec-5-4">5.4. update-score</a></li>
</ul>
</li>
<li><a href="#sec-6">6. Storage</a>
<ul>
<li><a href="#sec-6-1">6.1. Saving and Loading</a></li>
<li><a href="#sec-6-2">6.2. fill-mp3-paths</a></li>
<li><a href="#sec-6-3">6.3. matching vocab entries to mp3s</a></li>
</ul>
</li>
<li><a href="#sec-7">7. Testing Facilities</a>
<ul>
<li><a href="#sec-7-1">7.1. set comparisons</a></li>
<li><a href="#sec-7-2">7.2. load-from-hsk</a></li>
<li><a href="#sec-7-3">7.3. enumerate-qualified-elements</a></li>
<li><a href="#sec-7-4">7.4. refil-testing-pool</a></li>
<li><a href="#sec-7-5">7.5. hsk-spillover</a></li>
<li><a href="#sec-7-6">7.6. Vocab element qualification</a></li>
<li><a href="#sec-7-7">7.7. Presentation</a></li>
<li><a href="#sec-7-8">7.8. List construction</a></li>
<li><a href="#sec-7-9">7.9. Scoring</a></li>
<li><a href="#sec-7-10">7.10. display-and-play</a></li>
<li><a href="#sec-7-11">7.11. test-loop</a></li>
<li><a href="#sec-7-12">7.12. random-test</a></li>
</ul>
</li>
<li><a href="#sec-8">8. User Interface</a>
<ul>
<li><a href="#sec-8-1">8.1. Header</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Copyright (C) 2014 Riley E.</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">This program is free software: you can redistribute it and/or</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">modify it under the terms of the GNU General Public License as</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">published by the Free Software Foundation, either version 3 of</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">the License, or (at your option) any later version.</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">This program is distributed in the hope that it will be useful,</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">GNU General Public License for more details.</span>

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">You should have received a copy of the GNU General Public</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">License along with this program. If not, see</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;"><a href="http://www.gnu.org/licenses/">&lt;http://www.gnu.org/licenses/&gt;</a>.</span>
</pre>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Headers, Variables, Parameters</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> System description</h3>
<div class="outline-text-3" id="text-1-1">
<p>
The Chinese Vocab Drill software is written largely out of a desire for learning
more Common Lisp, better programming techniques, and the Chinese Mandarin
language. All editing is done in the .ORG file, and exported to PDF and HTML,
and the source code is "tangled" from the code blocks into the appropriate Lisp
files. This package takes advantage of several libraries:
</p>
<ul class="org-ul">
<li><a href="http://common-lisp.net/project/iterate/">iterate</a>:
<ul class="org-ul">
<li>The iterate package was written as a more Lispy and extensible alternative to
the standard LOOP macro.
</li>
</ul>
</li>
<li><a href="http://weitz.de/cl-ppcre/">cl-ppcre</a>:
<ul class="org-ul">
<li>A fast regular expression library, allows for sophisticated methods for
pattern matching, including creating of Scanners.
</li>
</ul>
</li>
<li><a href="http://common-lisp.net/project/external-program/">external-program</a>:
<ul class="org-ul">
<li>Allows an implementation-neutral access to external programs.
</li>
</ul>
</li>
<li><a href="http://common-lisp.net/project/bordeaux-threads/">bordeaux-threads</a>
<ul class="org-ul">
<li>a system for launching and managing threads as long as your Lisp system
provides support for them.
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> System Definition</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span>asdf:defsystem #<span style="color: #DCDCCC; font-weight: bold;">:cl-cvd</span>
  <span style="color: #DCDCCC; font-weight: bold;">:serial</span> t
  <span style="color: #DCDCCC; font-weight: bold;">:description</span> <span style="color: #CC9393;">"Chinese Vocabulary Drill"</span>
  <span style="color: #DCDCCC; font-weight: bold;">:author</span> <span style="color: #CC9393;">"Riley E."</span>
  <span style="color: #DCDCCC; font-weight: bold;">:license</span> <span style="color: #CC9393;">"GPLv3 or Later"</span>
  <span style="color: #DCDCCC; font-weight: bold;">:depends-on</span> <span style="color: #BFEBBF;">(</span><span style="color: #DCDCCC; font-weight: bold;">:iterate</span>
                <span style="color: #DCDCCC; font-weight: bold;">:cl-ppcre</span>
                <span style="color: #DCDCCC; font-weight: bold;">:cl-csv</span>
                <span style="color: #DCDCCC; font-weight: bold;">:external-program</span>
                <span style="color: #DCDCCC; font-weight: bold;">:bordeaux-threads</span>
                <span style="color: #DCDCCC; font-weight: bold;">:cl-cffi-gtk</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #DCDCCC; font-weight: bold;">:components</span> <span style="color: #BFEBBF;">(</span><span style="color: #D0BF8F;">(</span><span style="color: #DCDCCC; font-weight: bold;">:file</span> <span style="color: #CC9393;">"package"</span><span style="color: #D0BF8F;">)</span>
               <span style="color: #D0BF8F;">(</span><span style="color: #DCDCCC; font-weight: bold;">:file</span> <span style="color: #CC9393;">"cl-cvd"</span><span style="color: #D0BF8F;">)</span>
               <span style="color: #D0BF8F;">(</span><span style="color: #DCDCCC; font-weight: bold;">:file</span> <span style="color: #CC9393;">"cl-cvd-gui"</span><span style="color: #D0BF8F;">)</span>
               <span style="color: #D0BF8F;">(</span><span style="color: #DCDCCC; font-weight: bold;">:file</span> <span style="color: #CC9393;">"csv-import"</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Package Definition</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defpackage</span> #<span style="color: #DCDCCC; font-weight: bold;">:chinese-vocab-drill</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #DCDCCC; font-weight: bold;">:nicknames</span> #<span style="color: #DCDCCC; font-weight: bold;">:cl-cvd</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #DCDCCC; font-weight: bold;">:use</span> <span style="color: #DCDCCC; font-weight: bold;">:iterate</span> <span style="color: #DCDCCC; font-weight: bold;">:bordeaux-threads</span> <span style="color: #DCDCCC; font-weight: bold;">:cl-ppcre</span>
        <span style="color: #DCDCCC; font-weight: bold;">:cl-csv</span> <span style="color: #DCDCCC; font-weight: bold;">:gtk</span> <span style="color: #DCDCCC; font-weight: bold;">:gdk</span> <span style="color: #DCDCCC; font-weight: bold;">:gobject</span> <span style="color: #DCDCCC; font-weight: bold;">:glib</span> <span style="color: #DCDCCC; font-weight: bold;">:pango</span>
        <span style="color: #DCDCCC; font-weight: bold;">:cairo</span> <span style="color: #DCDCCC; font-weight: bold;">:cffi</span> <span style="color: #DCDCCC; font-weight: bold;">:external-program</span> <span style="color: #DCDCCC; font-weight: bold;">:cl</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> Global variables, and setting the package</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Initialize the hash-table, and the hash-table element counter, which is used for
generating the keys used to identify hash-table entries.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">in-package</span> <span style="color: #DCDCCC; font-weight: bold;">:cl-cvd</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">declaim</span> <span style="color: #BFEBBF;">(</span>optimize <span style="color: #D0BF8F;">(</span>speed 3<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>debug 3<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>safety 3<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

  <span style="color: #5F7F5F;">;;; </span><span style="color: #7F9F7F;">The constant PHI is used for spaced-repetition timing</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defconstant</span> <span style="color: #DFAF8F;">phi</span> 1.618033988749895d0
  <span style="color: #CC9393;">"The constant PHI, The golden ratio."</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defvar</span> <span style="color: #DFAF8F;">*zh-hash-table*</span> <span style="color: #BFEBBF;">(</span>make-hash-table<span style="color: #BFEBBF;">)</span>
  <span style="color: #9FC59F;">"Hash table for storing data of, and</span>
<span style="color: #9FC59F;">    metadata about the vocabulary listing"</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defvar</span> <span style="color: #DFAF8F;">*mp3dir*</span> nil<span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defvar</span> <span style="color: #DFAF8F;">*mp3-alist*</span> nil<span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defvar</span> <span style="color: #DFAF8F;">*vocab-key-count*</span> 0
  <span style="color: #9FC59F;">"Counter for the list of vocabulary entries,</span>
<span style="color: #9FC59F;">    is incremented on addition of elements, or set</span>
<span style="color: #9FC59F;">    when a data-set is loaded into the hash-table</span>
<span style="color: #9FC59F;">    by the `</span><span style="color: #BFEBBF;">import-vocab</span><span style="color: #9FC59F;">' function."</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defvar</span> <span style="color: #DFAF8F;">*test-pool*</span> nil
  <span style="color: #9FC59F;">"Words that have been seen during a practice session"</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defvar</span> <span style="color: #DFAF8F;">*current-hsk-level*</span> 1<span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defvar</span> <span style="color: #DFAF8F;">*punctuation*</span> <span style="color: #BFEBBF;">(</span>list #\.     #\,
                            #\;     #\:
                            #\/     #\\
                            #\|     #\!
                            #\-     #\_
                            #\(     #\) 
                            #\{     #\}
                            #\[     #\]
                            #\~     #\`
                            #\&lt;     #\&gt;
                            #\?     #\&amp;
                            #\"     #\+
                            #\=<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>

<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defvar</span> <span style="color: #DFAF8F;">*whitespace*</span> <span style="color: #BFEBBF;">(</span>list #\SPACE   #\Tab
                           #\NEWLINE #\BACKSPACE<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Structures</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Vocab Entry:
<ul class="org-ul">
<li>The <code>vocab-entry</code> data-structure provides the scaffolding for each
vocabulary item, as well as the metadata about each item, such as times
correct, time incorrect, last practice date, and number of total
repetitions.
</li>
</ul>
</li>
</ul>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defstruct</span> <span style="color: #7CB8BB;">vocab-entry</span>
  <span style="color: #BFEBBF;">(</span>hsk     1                    <span style="color: #DCDCCC; font-weight: bold;">:type</span> integer<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>hanzi   <span style="color: #CC9393;">""</span>                   <span style="color: #DCDCCC; font-weight: bold;">:type</span> string<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>pinyin  <span style="color: #CC9393;">""</span>                   <span style="color: #DCDCCC; font-weight: bold;">:type</span> string<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>english <span style="color: #D0BF8F;">(</span>list <span style="color: #CC9393;">""</span><span style="color: #D0BF8F;">)</span>            <span style="color: #DCDCCC; font-weight: bold;">:type</span> list<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>seealso <span style="color: #D0BF8F;">(</span>list <span style="color: #CC9393;">""</span><span style="color: #D0BF8F;">)</span>            <span style="color: #DCDCCC; font-weight: bold;">:type</span> list<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>units   <span style="color: #D0BF8F;">(</span>list <span style="color: #CC9393;">""</span><span style="color: #D0BF8F;">)</span>            <span style="color: #DCDCCC; font-weight: bold;">:type</span> list<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>score   <span style="color: #D0BF8F;">(</span>complex 0.0 0.0<span style="color: #D0BF8F;">)</span>    <span style="color: #DCDCCC; font-weight: bold;">:type</span> complex<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>date    <span style="color: #D0BF8F;">(</span>get-universal-time<span style="color: #D0BF8F;">)</span> <span style="color: #DCDCCC; font-weight: bold;">:type</span> integer<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>reps    1                    <span style="color: #DCDCCC; font-weight: bold;">:type</span> integer<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Comma-separated value import utilities</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Pre-parsing</h3>
<div class="outline-text-3" id="text-3-1">
</div><div id="outline-container-sec-3-1-1" class="outline-4">
<h4 id="sec-3-1-1">preprocess-english</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
Break up the generic English description rendered from the CSV by
splitting it at each semicolon.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">preprocess-english</span> <span style="color: #BFEBBF;">(</span>desc-string<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>car <span style="color: #D0BF8F;">(</span>read-csv desc-string <span style="color: #DCDCCC; font-weight: bold;">:separator</span> #\SEMICOLON<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-1-2" class="outline-4">
<h4 id="sec-3-1-2">collect-measures</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
Collect all applicable notes concerning units of measurement related to words
and generate a list of them. First checking to see if the object is a string at
all, then if the length is greater than four (to prevent errors, and because it
is a waste of time to scan such strings), then if the string begins with the
characters which designate a unit (in this case, "CL:".)
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">collect-measures</span> <span style="color: #BFEBBF;">(</span>l<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>iterate <span style="color: #D0BF8F;">(</span>for s in l<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> <span style="color: #93E0E3;">(</span>and <span style="color: #9FC59F;">(</span>stringp s<span style="color: #9FC59F;">)</span>
               <span style="color: #9FC59F;">(</span>&lt; 4 <span style="color: #94BFF3;">(</span>length s<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
               <span style="color: #9FC59F;">(</span>string= <span style="color: #94BFF3;">(</span>subseq s 0 3<span style="color: #94BFF3;">)</span> <span style="color: #CC9393;">"CL:"</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>collect s<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-1-3" class="outline-4">
<h4 id="sec-3-1-3">clean-measures</h4>
<div class="outline-text-4" id="text-3-1-3">
<p>
Prune the "CL:" from the head of measures to make displaying nicer.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">clean-measures</span> <span style="color: #BFEBBF;">(</span>s<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>regex-replace <span style="color: #CC9393;">"CL:"</span> s <span style="color: #CC9393;">""</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-1-4" class="outline-4">
<h4 id="sec-3-1-4">flatten</h4>
<div class="outline-text-4" id="text-3-1-4">
<p>
Flatten nested lists.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">flatten</span> <span style="color: #BFEBBF;">(</span>tree<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">declare</span> <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">inline</span> mapcaf<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> tree
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #93E0E3;">(</span>atom tree<span style="color: #93E0E3;">)</span>
        <span style="color: #93E0E3;">(</span>list tree<span style="color: #93E0E3;">)</span>
        <span style="color: #93E0E3;">(</span>reduce #'append
                <span style="color: #9FC59F;">(</span>mapcar #'flatten
                        tree<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-1-5" class="outline-4">
<h4 id="sec-3-1-5">finalize-measures</h4>
<div class="outline-text-4" id="text-3-1-5">
<p>
Take the collected measures, split them by commas into separate
strings, and flatten the resulting structure.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">finalize-measures</span> <span style="color: #BFEBBF;">(</span>l<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>objet-petit-a <span style="color: #9FC59F;">(</span>collect-measures l<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">unless</span> <span style="color: #93E0E3;">(</span>zerop <span style="color: #9FC59F;">(</span>length objet-petit-a<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>flatten
       <span style="color: #9FC59F;">(</span>mapcar #'cl-csv:read-csv
               <span style="color: #94BFF3;">(</span>mapcar #'clean-measures objet-petit-a<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-1-6" class="outline-4">
<h4 id="sec-3-1-6">clean-english</h4>
<div class="outline-text-4" id="text-3-1-6">
<p>
Remove all entries that are not themselves translations of the term,
but relate to either units of measurement, or hint to related terms.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">clean-english</span> <span style="color: #BFEBBF;">(</span>l<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>remove-if <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #93E0E3;">(</span>s<span style="color: #93E0E3;">)</span>
               <span style="color: #93E0E3;">(</span>or
                <span style="color: #9FC59F;">(</span>and <span style="color: #94BFF3;">(</span>&lt; 8 <span style="color: #E0CF9F;">(</span>length s<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
                     <span style="color: #94BFF3;">(</span>or <span style="color: #E0CF9F;">(</span>string= <span style="color: #8FB28F;">(</span>subseq s 0 8<span style="color: #8FB28F;">)</span> <span style="color: #CC9393;">"see also"</span><span style="color: #E0CF9F;">)</span>
                         <span style="color: #E0CF9F;">(</span>string= <span style="color: #8FB28F;">(</span>subseq s 0 9<span style="color: #8FB28F;">)</span> <span style="color: #CC9393;">"(see also"</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
                <span style="color: #9FC59F;">(</span>and <span style="color: #94BFF3;">(</span>&lt; 4 <span style="color: #E0CF9F;">(</span>length s<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
                     <span style="color: #94BFF3;">(</span>string= <span style="color: #E0CF9F;">(</span>subseq s 0 3<span style="color: #E0CF9F;">)</span> <span style="color: #CC9393;">"CL:"</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
             l<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Separating components</h3>
<div class="outline-text-3" id="text-3-2">
</div><div id="outline-container-sec-3-2-1" class="outline-4">
<h4 id="sec-3-2-1">collect-see-also</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
Collect strings from the results of <code>preprocess-english</code> that begin with "see
also".
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">collect-see-also</span> <span style="color: #BFEBBF;">(</span>l<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>iterate <span style="color: #D0BF8F;">(</span>for s in l<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> <span style="color: #93E0E3;">(</span>and <span style="color: #9FC59F;">(</span>stringp s<span style="color: #9FC59F;">)</span>
               <span style="color: #9FC59F;">(</span>&lt; 8 <span style="color: #94BFF3;">(</span>length s<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
               <span style="color: #9FC59F;">(</span>string= <span style="color: #94BFF3;">(</span>subseq s 0 8<span style="color: #94BFF3;">)</span> <span style="color: #CC9393;">"see also"</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>collect s<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Final restructuring of data</h3>
<div class="outline-text-3" id="text-3-3">
</div><div id="outline-container-sec-3-3-1" class="outline-4">
<h4 id="sec-3-3-1">eleml-to-struct</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
Break up the s-expressionized CSV line and name the elements, then perform
various operations on each of these elements, including further breaking up into
other specific values to be stored in the vocab-entry structure.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">eleml-to-struct</span> <span style="color: #BFEBBF;">(</span>l<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">destructuring-bind</span> <span style="color: #D0BF8F;">(</span>hsk hanzi pinyin description<span style="color: #D0BF8F;">)</span> l
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let*</span> <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>pre-english <span style="color: #94BFF3;">(</span>preprocess-english description<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
           <span style="color: #9FC59F;">(</span>units       <span style="color: #94BFF3;">(</span>finalize-measures  pre-english<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
           <span style="color: #9FC59F;">(</span>see-also    <span style="color: #94BFF3;">(</span>collect-see-also   pre-english<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
           <span style="color: #9FC59F;">(</span>english     <span style="color: #94BFF3;">(</span>clean-english      pre-english<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>make-vocab-entry <span style="color: #DCDCCC; font-weight: bold;">:hsk</span>     <span style="color: #9FC59F;">(</span>read-from-string hsk<span style="color: #9FC59F;">)</span>
                        <span style="color: #DCDCCC; font-weight: bold;">:hanzi</span>   hanzi
                        <span style="color: #DCDCCC; font-weight: bold;">:pinyin</span>  pinyin
                        <span style="color: #DCDCCC; font-weight: bold;">:english</span> english
                        <span style="color: #DCDCCC; font-weight: bold;">:units</span>   units
                        <span style="color: #DCDCCC; font-weight: bold;">:seealso</span> see-also<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-3-2" class="outline-4">
<h4 id="sec-3-3-2">batch-add-table</h4>
<div class="outline-text-4" id="text-3-3-2">
<p>
Copy the entire result of a <code>parse-csv</code> operation into a hash table using the
predefined functions above.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">batch-add-table</span> <span style="color: #BFEBBF;">(</span>l<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">dolist</span> <span style="color: #D0BF8F;">(</span>lx l<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>puthash <span style="color: #93E0E3;">(</span>gen-ht-key 'zh-index<span style="color: #93E0E3;">)</span>
             *zh-hash-table*
             <span style="color: #93E0E3;">(</span>eleml-to-struct lx<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Data-store utility functions</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> element-of-truth</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Check a list for any non-nil values. 
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">element-of-truth</span> <span style="color: #BFEBBF;">(</span>l<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>iterate <span style="color: #D0BF8F;">(</span>for i in l<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> i <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">return</span> i<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> gen-ht-key</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Create keys used for labeling objects in a hash table. This is needed because
attempting to use any of the more "meaningful" values contained within the
hash-value itself ends up causing more difficulty than anything else.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">gen-ht-key</span> <span style="color: #BFEBBF;">(</span>prefix<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>the-sym-name <span style="color: #9FC59F;">(</span>format nil <span style="color: #CC9393;">"~D-~D"</span> prefix <span style="color: #94BFF3;">(</span>incf *vocab-key-count*<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>intern the-sym-name <span style="color: #DCDCCC; font-weight: bold;">:cl-cvd</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> key-exists-p</h3>
<div class="outline-text-3" id="text-4-3">
<p>
Test to see if a key is already assigned within a hash-table
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">key-exists-p</span> <span style="color: #BFEBBF;">(</span>key table<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>target <span style="color: #9FC59F;">(</span>gethash key table<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> target key<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> puthash</h3>
<div class="outline-text-3" id="text-4-4">
<p>
Wrap the <code>setf</code> clause in a function for adding/modifying entries in a hash-table
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">puthash</span> <span style="color: #BFEBBF;">(</span>key table object<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>setf <span style="color: #D0BF8F;">(</span>gethash key table<span style="color: #D0BF8F;">)</span> object<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5"><span class="section-number-3">4.5</span> hash-table searching functions</h3>
<div class="outline-text-3" id="text-4-5">
</div><div id="outline-container-sec-4-5-1" class="outline-4">
<h4 id="sec-4-5-1">hsk-apropos</h4>
<div class="outline-text-4" id="text-4-5-1">
<p>
Search for and collect items that match a specified <a href="http://en.wikipedia.org/wiki/Hanyu_Shuiping_Kaoshi">HSK</a> level.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">hsk-apropos</span> <span style="color: #BFEBBF;">(</span>level<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">declare</span> <span style="color: #D0BF8F;">(</span>fixnum level<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">loop</span> <span style="color: #DCDCCC; font-weight: bold;">:for</span> key <span style="color: #DCDCCC; font-weight: bold;">:being</span> the hash-keys <span style="color: #DCDCCC; font-weight: bold;">:of</span> *zh-hash-table*
        <span style="color: #DCDCCC; font-weight: bold;">:for</span> val <span style="color: #DCDCCC; font-weight: bold;">:being</span> the hash-value <span style="color: #DCDCCC; font-weight: bold;">:of</span> *zh-hash-table*
        <span style="color: #DCDCCC; font-weight: bold;">:when</span> <span style="color: #D0BF8F;">(</span>= level <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">the</span> fixnum <span style="color: #9FC59F;">(</span>vocab-entry-hsk val<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
          <span style="color: #DCDCCC; font-weight: bold;">:collect</span> key<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-5-2" class="outline-4">
<h4 id="sec-4-5-2">zh-apropos</h4>
<div class="outline-text-4" id="text-4-5-2">
<p>
Search the hash table for a matching Hanzi entry and return it with the hash key
associated with the vocabulary entry found in a list in the form <code>(&lt;key&gt;
&lt;vocab-entry&gt;)</code>.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">zh-apropos</span> <span style="color: #BFEBBF;">(</span>zh-string<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">declare</span> <span style="color: #D0BF8F;">(</span>string zh-string<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">loop</span> <span style="color: #DCDCCC; font-weight: bold;">:for</span> key <span style="color: #DCDCCC; font-weight: bold;">:being</span> the hash-keys <span style="color: #DCDCCC; font-weight: bold;">:of</span> *zh-hash-table*
        <span style="color: #DCDCCC; font-weight: bold;">:for</span> val <span style="color: #DCDCCC; font-weight: bold;">:being</span> the hash-value <span style="color: #DCDCCC; font-weight: bold;">:of</span> *zh-hash-table*
        <span style="color: #DCDCCC; font-weight: bold;">:when</span> <span style="color: #D0BF8F;">(</span>scan zh-string <span style="color: #93E0E3;">(</span>vocab-entry-hanzi val<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
          <span style="color: #DCDCCC; font-weight: bold;">:collect</span> <span style="color: #D0BF8F;">(</span>list key val<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-5-3" class="outline-4">
<h4 id="sec-4-5-3">zh-apropos-key</h4>
<div class="outline-text-4" id="text-4-5-3">
<p>
Find vocabulary entries where the provided <code>zh-string</code> is at least a subset of
the string stored in the entry's <code>:hanzi</code> slot. Return a list of hash-keys of
the relevant vocabulary entries.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">zh-apropos-key</span> <span style="color: #BFEBBF;">(</span>zh-string<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">declare</span> <span style="color: #D0BF8F;">(</span>string zh-string<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">loop</span> <span style="color: #DCDCCC; font-weight: bold;">:for</span> key <span style="color: #DCDCCC; font-weight: bold;">:being</span> the hash-keys  <span style="color: #DCDCCC; font-weight: bold;">:of</span> *zh-hash-table*
        <span style="color: #DCDCCC; font-weight: bold;">:for</span> val <span style="color: #DCDCCC; font-weight: bold;">:being</span> the hash-value <span style="color: #DCDCCC; font-weight: bold;">:of</span> *zh-hash-table*
        <span style="color: #DCDCCC; font-weight: bold;">:when</span> <span style="color: #D0BF8F;">(</span>scan zh-string <span style="color: #93E0E3;">(</span>vocab-entry-hanzi val<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
          <span style="color: #DCDCCC; font-weight: bold;">:collect</span> key<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-5-4" class="outline-4">
<h4 id="sec-4-5-4">en-apropos</h4>
<div class="outline-text-4" id="text-4-5-4">
<p>
Find a vocab entry which contains a specified substring within its <code>:english</code> slot.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">en-apropos</span> <span style="color: #BFEBBF;">(</span>en-string<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">declare</span> <span style="color: #D0BF8F;">(</span>string en-string<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">loop</span> <span style="color: #DCDCCC; font-weight: bold;">:for</span> key <span style="color: #DCDCCC; font-weight: bold;">:being</span> the hash-keys <span style="color: #DCDCCC; font-weight: bold;">:of</span> *zh-hash-table*
        <span style="color: #DCDCCC; font-weight: bold;">:for</span> val <span style="color: #DCDCCC; font-weight: bold;">:being</span> the hash-value <span style="color: #DCDCCC; font-weight: bold;">:of</span> *zh-hash-table*
        <span style="color: #DCDCCC; font-weight: bold;">:when</span> <span style="color: #D0BF8F;">(</span>element-of-truth
               <span style="color: #93E0E3;">(</span>mapcar <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #94BFF3;">(</span>s<span style="color: #94BFF3;">)</span>
                         <span style="color: #94BFF3;">(</span>scan en-string s<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
                       <span style="color: #9FC59F;">(</span>vocab-entry-english val<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
          <span style="color: #DCDCCC; font-weight: bold;">:collect</span> <span style="color: #D0BF8F;">(</span>list key val<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-5-5" class="outline-4">
<h4 id="sec-4-5-5">en-apropos-word</h4>
<div class="outline-text-4" id="text-4-5-5">
<p>
Find a vocab entry which contains a discreet word, separated by punctuation on
either side, or at either end of the whole sequence.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">en-apropos-word</span> <span style="color: #BFEBBF;">(</span>en-word<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">declare</span> <span style="color: #D0BF8F;">(</span>string en-word<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">loop</span> <span style="color: #DCDCCC; font-weight: bold;">:for</span> key <span style="color: #DCDCCC; font-weight: bold;">:being</span> the hash-keys <span style="color: #DCDCCC; font-weight: bold;">:of</span> *zh-hash-table*
        <span style="color: #DCDCCC; font-weight: bold;">:for</span> val <span style="color: #DCDCCC; font-weight: bold;">:being</span> the hash-value <span style="color: #DCDCCC; font-weight: bold;">:of</span> *zh-hash-table*
        <span style="color: #DCDCCC; font-weight: bold;">:when</span> <span style="color: #D0BF8F;">(</span>element-of-truth
               <span style="color: #93E0E3;">(</span>mapcar <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #94BFF3;">(</span>s<span style="color: #94BFF3;">)</span>
                         <span style="color: #94BFF3;">(</span>find-word-in-string en-word s<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
                       <span style="color: #9FC59F;">(</span>vocab-entry-english val<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
          <span style="color: #DCDCCC; font-weight: bold;">:collect</span> <span style="color: #D0BF8F;">(</span>list key val<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
<ul class="org-ul"><li><a id="sec-4-5-5-1" name="sec-4-5-5-1"></a>find-word-in-string<br  /><div class="outline-text-5" id="text-4-5-5-1">
<p>
Find a whole word within a provided string, delineated by an end of the
<code>target-string</code> or any predefined punctuation mark as defined within the
<code>delimiter-p</code> enclosed functions.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">find-word-in-string</span> <span style="color: #BFEBBF;">(</span>word target-string<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">declare</span> <span style="color: #D0BF8F;">(</span>string word target-string<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">multiple-value-bind</span> <span style="color: #D0BF8F;">(</span>word-begin word-end<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>scan word target-string<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> <span style="color: #93E0E3;">(</span>and word-begin word-end<span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">cond</span> <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">(</span>string= word target-string<span style="color: #94BFF3;">)</span> word<span style="color: #9FC59F;">)</span>
            <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">(</span>and <span style="color: #E0CF9F;">(</span>or <span style="color: #8FB28F;">(</span>zerop word-begin<span style="color: #8FB28F;">)</span>
                      <span style="color: #8FB28F;">(</span>delimiter-p <span style="color: #6CA0A3;">(</span>char target-string <span style="color: #DCDCCC;">(</span>- word-begin 1<span style="color: #DCDCCC;">)</span><span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span>
                  <span style="color: #E0CF9F;">(</span>or <span style="color: #8FB28F;">(</span>= <span style="color: #6CA0A3;">(</span>length target-string<span style="color: #6CA0A3;">)</span> word-end<span style="color: #8FB28F;">)</span>
                      <span style="color: #8FB28F;">(</span>delimiter-p <span style="color: #6CA0A3;">(</span>char target-string word-end<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
             word<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</li>
<li><a id="sec-4-5-5-2" name="sec-4-5-5-2"></a>delimiter-p<br  /><div class="outline-text-5" id="text-4-5-5-2">
<p>
Define a set of functions for retrieving and manipulating a stored list of
punctuation-marks and white-space characters.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">delimiter-p</span> <span style="color: #BFEBBF;">(</span>chr<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>or <span style="color: #D0BF8F;">(</span>member chr *punctuations*<span style="color: #D0BF8F;">)</span>
      <span style="color: #D0BF8F;">(</span>member chr *whitespace*<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</li></ul>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Entry manipulation</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> add-entry</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Create a new instance of <code>vocab-entry</code> and install it into the primary
hash-table with a unique key.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">add-entry</span> <span style="color: #BFEBBF;">(</span><span style="color: #7CB8BB;">&amp;key</span> hanzi pinyin english <span style="color: #D0BF8F;">(</span>hsk 0<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>hash-table *zh-hash-table*<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>puthash <span style="color: #D0BF8F;">(</span>gen-ht-key 'zh-index<span style="color: #D0BF8F;">)</span>
           hash-table
           <span style="color: #D0BF8F;">(</span>make-vocab-entry <span style="color: #DCDCCC; font-weight: bold;">:hanzi</span>   hanzi
                             <span style="color: #DCDCCC; font-weight: bold;">:pinyin</span>  pinyin
                             <span style="color: #DCDCCC; font-weight: bold;">:english</span> english
                             <span style="color: #DCDCCC; font-weight: bold;">:hsk</span>     hsk<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> revise-entry</h3>
<div class="outline-text-3" id="text-5-2">
<p>
Modify an entry by accepting a field parameter, and a replacement value.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">revise-entry</span> <span style="color: #BFEBBF;">(</span><span style="color: #7CB8BB;">&amp;key</span> key field new-data <span style="color: #D0BF8F;">(</span>hash-table *zh-hash-table*<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>the-object <span style="color: #9FC59F;">(</span>gethash key hash-table<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">case</span> field
      <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>hanzi<span style="color: #9FC59F;">)</span>   <span style="color: #9FC59F;">(</span>setf <span style="color: #94BFF3;">(</span>vocab-entry-hanzi   the-object<span style="color: #94BFF3;">)</span> new-data<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>pinyin<span style="color: #9FC59F;">)</span>  <span style="color: #9FC59F;">(</span>setf <span style="color: #94BFF3;">(</span>vocab-entry-pinyin  the-object<span style="color: #94BFF3;">)</span> new-data<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>english<span style="color: #9FC59F;">)</span> <span style="color: #9FC59F;">(</span>setf <span style="color: #94BFF3;">(</span>vocab-entry-english the-object<span style="color: #94BFF3;">)</span> new-data<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> append-english</h3>
<div class="outline-text-3" id="text-5-3">
<p>
Append additional English terms to the <code>:english</code> slot in a <code>vocab-entry</code>
instance.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">append-english</span> <span style="color: #BFEBBF;">(</span>english-strings <span style="color: #7CB8BB;">&amp;key</span> key <span style="color: #D0BF8F;">(</span>hash-table *zh-hash-table*<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>the-object <span style="color: #9FC59F;">(</span>gethash key hash-table<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>revise-entry <span style="color: #93E0E3;">(</span>append <span style="color: #9FC59F;">(</span>vocab-entry-english the-object<span style="color: #9FC59F;">)</span> english-strings<span style="color: #93E0E3;">)</span>
                  <span style="color: #DCDCCC; font-weight: bold;">:key</span> key
                  <span style="color: #DCDCCC; font-weight: bold;">:field</span> 'english<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> update-score</h3>
<div class="outline-text-3" id="text-5-4">
<p>
Update the score stored in a <code>vocab-entry</code> instance based on the results of
<code>check-answer</code> and <code>score-result</code>.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">update-score</span> <span style="color: #BFEBBF;">(</span>answer hash-key test-type <span style="color: #7CB8BB;">&amp;key</span> <span style="color: #D0BF8F;">(</span>hash-table *zh-hash-table*<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>vocab-entry <span style="color: #9FC59F;">(</span>gethash hash-key hash-table<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>setf <span style="color: #93E0E3;">(</span>vocab-entry-score vocab-entry<span style="color: #93E0E3;">)</span>
          <span style="color: #93E0E3;">(</span>+ <span style="color: #9FC59F;">(</span>vocab-entry-score vocab-entry<span style="color: #9FC59F;">)</span>
             <span style="color: #9FC59F;">(</span>score-result <span style="color: #94BFF3;">(</span><span style="color: #D0BF8F; font-weight: bold;">check-answer</span> answer vocab-entry test-type<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>setf <span style="color: #93E0E3;">(</span>vocab-entry-date vocab-entry<span style="color: #93E0E3;">)</span>
          <span style="color: #93E0E3;">(</span>get-universal-time<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>incf <span style="color: #93E0E3;">(</span>vocab-entry-reps vocab-entry<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Storage</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> Saving and Loading</h3>
<div class="outline-text-3" id="text-6-1">
</div><div id="outline-container-sec-6-1-1" class="outline-4">
<h4 id="sec-6-1-1">export-vocab</h4>
<div class="outline-text-4" id="text-6-1-1">
<p>
The <code>export-vocab</code> function arose out of a finding that hash-table objects
differ slightly between Common Lisp implementations.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">export-vocab</span> <span style="color: #BFEBBF;">(</span><span style="color: #7CB8BB;">&amp;key</span> <span style="color: #D0BF8F;">(</span>vocab-table *zh-hash-table*<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>filename <span style="color: #CC9393;">"zh-portable.raw"</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span> 
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>the-alist<span style="color: #93E0E3;">)</span> <span style="color: #93E0E3;">(</span>count 0<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">labels</span> <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>destructure-vocab <span style="color: #94BFF3;">(</span>x y<span style="color: #94BFF3;">)</span>
               <span style="color: #94BFF3;">(</span>push <span style="color: #E0CF9F;">(</span>list x y<span style="color: #E0CF9F;">)</span> the-alist<span style="color: #94BFF3;">)</span>
               <span style="color: #94BFF3;">(</span>incf count<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>maphash #'destructure-vocab vocab-table<span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">with-open-file</span> <span style="color: #9FC59F;">(</span>out filename
                           <span style="color: #DCDCCC; font-weight: bold;">:direction</span> <span style="color: #DCDCCC; font-weight: bold;">:output</span>
                           <span style="color: #DCDCCC; font-weight: bold;">:if-exists</span> <span style="color: #DCDCCC; font-weight: bold;">:supersede</span><span style="color: #9FC59F;">)</span>
        <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">with-standard-io-syntax</span>
          <span style="color: #94BFF3;">(</span>pprint the-alist out<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    count<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-1-2" class="outline-4">
<h4 id="sec-6-1-2">import-vocab</h4>
<div class="outline-text-4" id="text-6-1-2">
<p>
The obvious counterpart to <code>export-vocab</code>.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">import-vocab</span> <span style="color: #BFEBBF;">(</span><span style="color: #7CB8BB;">&amp;key</span> <span style="color: #D0BF8F;">(</span>vocab-table *zh-hash-table*<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>filename <span style="color: #CC9393;">"zh-portable.raw"</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">labels</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>structure-vocab <span style="color: #9FC59F;">(</span>l<span style="color: #9FC59F;">)</span>
             <span style="color: #9FC59F;">(</span>puthash <span style="color: #94BFF3;">(</span>car l<span style="color: #94BFF3;">)</span> vocab-table <span style="color: #94BFF3;">(</span>cadr l<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">with-open-file</span> <span style="color: #93E0E3;">(</span>in filename<span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">declare</span> <span style="color: #9FC59F;">(</span>dynamic-extent in<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">with-standard-io-syntax</span>
        <span style="color: #9FC59F;">(</span>mapcar #'structure-vocab <span style="color: #94BFF3;">(</span>read in<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>setf *vocab-key-count* <span style="color: #93E0E3;">(</span>hash-table-count *zh-hash-table*<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
<p>
MP3s and the original data-set were provided by <i>lingomi</i>.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> fill-mp3-paths</h3>
<div class="outline-text-3" id="text-6-2">
<p>
Set the variable <code>*mp3dir*</code> to be a list of paths to each of the MP3s for the
vocab tests.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">fill-mp3-paths</span> <span style="color: #BFEBBF;">()</span>
  <span style="color: #BFEBBF;">(</span>setf *mp3dir* <span style="color: #D0BF8F;">(</span>directory #P<span style="color: #CC9393;">"~/chinese/hsk_mp3/*.mp3"</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  nil<span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3"><span class="section-number-3">6.3</span> matching vocab entries to mp3s</h3>
<div class="outline-text-3" id="text-6-3">
</div><div id="outline-container-sec-6-3-1" class="outline-4">
<h4 id="sec-6-3-1">find-mp3-path</h4>
<div class="outline-text-4" id="text-6-3-1">
<p>
Search a list of mp3 files for a match with a predefined pinyin string.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">find-mp3-path</span> <span style="color: #BFEBBF;">(</span>match-name<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>iterate <span style="color: #D0BF8F;">(</span>for elt in *mp3dir*<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>finding elt such-that <span style="color: #93E0E3;">(</span>scan match-name <span style="color: #9FC59F;">(</span>namestring elt<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-3-2" class="outline-4">
<h4 id="sec-6-3-2">find-matching-mp3</h4>
<div class="outline-text-4" id="text-6-3-2">
<p>
Match a given vocabulary key to a list of mp3 files
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">find-matching-mp3</span> <span style="color: #BFEBBF;">(</span>vocab-key<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let*</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>vocab-entry <span style="color: #9FC59F;">(</span>gethash vocab-key *zh-hash-table*<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
         <span style="color: #93E0E3;">(</span>pinyin <span style="color: #9FC59F;">(</span>vocab-entry-pinyin vocab-entry<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
         <span style="color: #93E0E3;">(</span>nospace <span style="color: #9FC59F;">(</span>regex-replace <span style="color: #CC9393;">" "</span> pinyin <span style="color: #CC9393;">""</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
         <span style="color: #93E0E3;">(</span>match-name <span style="color: #9FC59F;">(</span>concatenate 'string <span style="color: #CC9393;">"-"</span> nospace <span style="color: #CC9393;">"-"</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
         <span style="color: #93E0E3;">(</span>mp3-path <span style="color: #9FC59F;">(</span>find-mp3-path match-name<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> mp3-path
      <span style="color: #93E0E3;">(</span>push <span style="color: #9FC59F;">(</span>list vocab-key
                  <span style="color: #94BFF3;">(</span>namestring mp3-path<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
            *mp3-alist*<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-3-3" class="outline-4">
<h4 id="sec-6-3-3">find-active-vocab-mp3s</h4>
<div class="outline-text-4" id="text-6-3-3">
<p>
Look for mp3s which match the contents of the <code>*mp3dir*</code> variable, if it is not
already in the <code>*mp3-alist*</code>, add it in the form of <code>(KEY PATH-TO-MP3)</code>.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">find-active-vocab-mp3s</span> <span style="color: #BFEBBF;">(</span><span style="color: #7CB8BB;">&amp;optional</span> <span style="color: #D0BF8F;">(</span>source-list *mp3dir*<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>mapcar <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #93E0E3;">(</span>key<span style="color: #93E0E3;">)</span>
            <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">unless</span> <span style="color: #9FC59F;">(</span>assoc key *mp3-alist*<span style="color: #9FC59F;">)</span>
              <span style="color: #9FC59F;">(</span>find-matching-mp3 key<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
          source-list<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-6-3-4" class="outline-4">
<h4 id="sec-6-3-4">play-mp3</h4>
<div class="outline-text-4" id="text-6-3-4">
<p>
Launch a thread that runs a program with the appropriate filename as returned by
an association list lookup.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">play-mp3</span> <span style="color: #BFEBBF;">(</span>key<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>bordeaux-threads:make-thread <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #93E0E3;">()</span>
                                  <span style="color: #93E0E3;">(</span>run <span style="color: #CC9393;">"/usr/bin/mpg123"</span>
                                       <span style="color: #9FC59F;">(</span>cdr <span style="color: #94BFF3;">(</span>assoc key *mp3-alist*<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
                                <span style="color: #DCDCCC; font-weight: bold;">:name</span> <span style="color: #CC9393;">"mp3 playback thread"</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Testing Facilities</h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> set comparisons</h3>
<div class="outline-text-3" id="text-7-1">
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">is-subset-p</span> <span style="color: #BFEBBF;">(</span>set-x set-y<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">labels</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>subset-p <span style="color: #9FC59F;">(</span>set-x set-y<span style="color: #9FC59F;">)</span>
             <span style="color: #9FC59F;">(</span>not <span style="color: #94BFF3;">(</span>set-difference set-x set-y<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>and <span style="color: #93E0E3;">(</span>subset-p set-x set-y<span style="color: #93E0E3;">)</span>
         <span style="color: #93E0E3;">(</span>subset-p set-y set-x<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2"><span class="section-number-3">7.2</span> load-from-hsk</h3>
<div class="outline-text-3" id="text-7-2">
<p>
Useful for bootstrapping vocab-element selection.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">load-from-hsk</span> <span style="color: #BFEBBF;">(</span>hsk-val <span style="color: #7CB8BB;">&amp;optional</span> <span style="color: #D0BF8F;">(</span>n 10<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>base <span style="color: #9FC59F;">(</span>length *test-pool*<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>setf *test-pool*
          <span style="color: #93E0E3;">(</span>nconc *test-pool*
                 <span style="color: #9FC59F;">(</span>subseq <span style="color: #94BFF3;">(</span>reverse <span style="color: #E0CF9F;">(</span>hsk-apropos hsk-val<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
                         base
                         <span style="color: #94BFF3;">(</span>+ n base<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3"><span class="section-number-3">7.3</span> enumerate-qualified-elements</h3>
<div class="outline-text-3" id="text-7-3">
<p>
Check the number of elements that have qualified since the last test occurred,
This is used to check to see if the minimal number of elements required for a
test can be called in without overlapping cooldown-times.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">enumerate-qualified-elements</span> <span style="color: #BFEBBF;">()</span>
  <span style="color: #BFEBBF;">(</span>length <span style="color: #D0BF8F;">(</span>remove-if-not #'qualified-p *test-pool*<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-4" class="outline-3">
<h3 id="sec-7-4"><span class="section-number-3">7.4</span> refil-testing-pool</h3>
<div class="outline-text-3" id="text-7-4">
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">refil-testing-pool</span> <span style="color: #BFEBBF;">(</span>hsk upper-bound<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>load-from-hsk hsk <span style="color: #D0BF8F;">(</span>- upper-bound <span style="color: #93E0E3;">(</span>enumerate-qualified-elements<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-7-5" class="outline-3">
<h3 id="sec-7-5"><span class="section-number-3">7.5</span> hsk-spillover</h3>
<div class="outline-text-3" id="text-7-5">
<p>
When a testing level is exhausted, pull more from the next level up.
If there are no more levels, don't increment.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">hsk-spillover</span> <span style="color: #BFEBBF;">()</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>and <span style="color: #93E0E3;">(</span>hsk-apropos <span style="color: #9FC59F;">(</span>+ *current-hsk-level* 1<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
           <span style="color: #93E0E3;">(</span>set-equal-p *test-pool* <span style="color: #9FC59F;">(</span>hsk-apropos *current-hsk-level*<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
      <span style="color: #D0BF8F;">(</span>incf *current-hsk-level*<span style="color: #D0BF8F;">)</span>
      <span style="color: #D0BF8F;">(</span>format nil <span style="color: #CC9393;">"Takeshi: ``</span><span style="color: #BFEBBF;">Amazing!</span><span style="color: #CC9393;">''"</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-6" class="outline-3">
<h3 id="sec-7-6"><span class="section-number-3">7.6</span> Vocab element qualification</h3>
<div class="outline-text-3" id="text-7-6">
</div><div id="outline-container-sec-7-6-1" class="outline-4">
<h4 id="sec-7-6-1">count-spaces</h4>
<div class="outline-text-4" id="text-7-6-1">
<p>
Determine the complexity of an example by counting the spaces in a string. This
is used to determine if one should be expected to enter the english equivalent
of a selected Chinese text sample.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">count-spaces</span> <span style="color: #BFEBBF;">(</span>str<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>space-count 0<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>iterate <span style="color: #93E0E3;">(</span>for chr in-string str<span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> <span style="color: #9FC59F;">(</span>char= chr #\SPACE<span style="color: #9FC59F;">)</span>
        <span style="color: #9FC59F;">(</span>incf space-count<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>finally <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">return</span> space-count<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-6-2" class="outline-4">
<h4 id="sec-7-6-2">english-sensible-p</h4>
<div class="outline-text-4" id="text-7-6-2">
<p>
Check to see if any constituents of the english parameter of a particular entry
can be expected to be remembered verbatim and entered when prompted for an
English answer. Perhaps this could be mitigated with a check against a digital
thesaurus.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">english-sensible-p</span> <span style="color: #BFEBBF;">(</span>vocab-entry<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>element-of-truth <span style="color: #D0BF8F;">(</span>mapcar <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #9FC59F;">(</span>s<span style="color: #9FC59F;">)</span>
                              <span style="color: #9FC59F;">(</span>&lt; <span style="color: #94BFF3;">(</span>count-spaces s<span style="color: #94BFF3;">)</span> 2<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
                            <span style="color: #93E0E3;">(</span>vocab-entry-english vocab-entry<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-6-3" class="outline-4">
<h4 id="sec-7-6-3">sensible-tests</h4>
<div class="outline-text-4" id="text-7-6-3">
<p>
A bit crude, but return a list of appropriate tests based on the response of
<code>english-sensible-p</code>.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">sensible-tests</span> <span style="color: #BFEBBF;">(</span>vocab-element<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>english-qualified-p vocab-element<span style="color: #D0BF8F;">)</span>
      <span style="color: #D0BF8F;">(</span>list 'english 'hanzi 'pinyin<span style="color: #D0BF8F;">)</span>
      <span style="color: #D0BF8F;">(</span>list 'hanzi 'pinyin<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-6-4" class="outline-4">
<h4 id="sec-7-6-4">qualified-p</h4>
<div class="outline-text-4" id="text-7-6-4">
<p>
Test to see which vocabulary elements qualify for testing at a given time.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">qualified-p</span> <span style="color: #BFEBBF;">(</span>vocab-struct<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>and <span style="color: #D0BF8F;">(</span>&gt; 10 <span style="color: #93E0E3;">(</span>vocab-entry-reps vocab-struct<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
       <span style="color: #D0BF8F;">(</span>&gt; <span style="color: #93E0E3;">(</span>get-universal-time<span style="color: #93E0E3;">)</span>
          <span style="color: #93E0E3;">(</span>vocab-entry-date vocab-struct<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-6-5" class="outline-4">
<h4 id="sec-7-6-5">set-next-test</h4>
<div class="outline-text-4" id="text-7-6-5">
<p>
Set the <code>:date</code> slot in a given vocab structure to the next scheduled test based
upon the number of times it has been correctly answered.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">set-next-test</span> <span style="color: #BFEBBF;">(</span>vocab-struct<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>setf <span style="color: #D0BF8F;">(</span>vocab-entry-date vocab-struct<span style="color: #D0BF8F;">)</span>
        <span style="color: #D0BF8F;">(</span>schedule-next-test vocab-struct<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-7-7" class="outline-3">
<h3 id="sec-7-7"><span class="section-number-3">7.7</span> Presentation</h3>
<div class="outline-text-3" id="text-7-7">
</div><div id="outline-container-sec-7-7-1" class="outline-4">
<h4 id="sec-7-7-1">show-challenge</h4>
<div class="outline-text-4" id="text-7-7-1">
<p>
Take a <code>field</code> and <code>key</code>, and respond with a string from the requested
field. A field value of <code>english</code> will return a random string from the list
located in the <code>:english</code> field of the selected <code>vocab-entry</code>, and <code>english-all</code>
will return a string containing all the elements of the list. A value of
<code>pinyin</code> will return a pinyin string, and <code>hanzi</code> will return the Chinese
ideographs.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">show-challenge</span> <span style="color: #BFEBBF;">(</span><span style="color: #7CB8BB;">&amp;key</span> field key <span style="color: #D0BF8F;">(</span>hash-table *zh-hash-table*<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>the-object <span style="color: #9FC59F;">(</span>gethash key hash-table<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">case</span> field
      <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>english<span style="color: #9FC59F;">)</span>     <span style="color: #9FC59F;">(</span>nth <span style="color: #94BFF3;">(</span>random <span style="color: #E0CF9F;">(</span>length <span style="color: #8FB28F;">(</span>vocab-entry-english the-object<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
                          <span style="color: #94BFF3;">(</span>vocab-entry-english the-object<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>english-all<span style="color: #9FC59F;">)</span> <span style="color: #9FC59F;">(</span>format nil <span style="color: #CC9393;">"~{~A~^, ~}."</span> <span style="color: #94BFF3;">(</span>vocab-entry-english the-object<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>pinyin<span style="color: #9FC59F;">)</span>      <span style="color: #9FC59F;">(</span>vocab-entry-pinyin the-object<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>hanzi<span style="color: #9FC59F;">)</span>       <span style="color: #9FC59F;">(</span>vocab-entry-hanzi the-object<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-7-2" class="outline-4">
<h4 id="sec-7-7-2">take-answer</h4>
<div class="outline-text-4" id="text-7-7-2">
<p>
A simple silly test.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">take-answer</span> <span style="color: #BFEBBF;">(</span><span style="color: #7CB8BB;">&amp;key</span> test<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>format t <span style="color: #CC9393;">"~D&gt; "</span> test<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>read-line<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-7-8" class="outline-3">
<h3 id="sec-7-8"><span class="section-number-3">7.8</span> List construction</h3>
<div class="outline-text-3" id="text-7-8">
</div><div id="outline-container-sec-7-8-1" class="outline-4">
<h4 id="sec-7-8-1">construct-test-list</h4>
<div class="outline-text-4" id="text-7-8-1">
<p>
Build up a sample of vocab items for a test battery.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">construct-test-list</span> <span style="color: #BFEBBF;">(</span>length <span style="color: #7CB8BB;">&amp;key</span> <span style="color: #D0BF8F;">(</span>test-pool *test-pool*<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>vocab *zh-hash-table*<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #9FC59F;">"Construct a test list of LENGTH members"</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>repeat 0<span style="color: #93E0E3;">)</span>
        <span style="color: #93E0E3;">(</span>result<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>iterate <span style="color: #93E0E3;">(</span>for key in test-pool<span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #9FC59F;">(</span>&gt;= repeat length<span style="color: #9FC59F;">)</span>
          result
          <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> <span style="color: #94BFF3;">(</span>qualified-p <span style="color: #E0CF9F;">(</span>gethash key vocab<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
            <span style="color: #94BFF3;">(</span>incf repeat<span style="color: #94BFF3;">)</span>
            <span style="color: #94BFF3;">(</span>collect key into result at beginning<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-8-2" class="outline-4">
<h4 id="sec-7-8-2">reconstruct-test-pool</h4>
<div class="outline-text-4" id="text-7-8-2">
<p>
Rebuild the testing pool from the base vocab library by searching for items that
have already been seen in practice.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">reconstruct-test-pool</span> <span style="color: #BFEBBF;">()</span>
  <span style="color: #BFEBBF;">(</span>maphash <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">lambda</span> <span style="color: #93E0E3;">(</span>key val<span style="color: #93E0E3;">)</span>
             <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> <span style="color: #9FC59F;">(</span>&lt; 1 <span style="color: #94BFF3;">(</span>vocab-entry-reps val<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
               <span style="color: #9FC59F;">(</span>push key *test-pool*<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
           *zh-hash-table*<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-7-9" class="outline-3">
<h3 id="sec-7-9"><span class="section-number-3">7.9</span> Scoring</h3>
<div class="outline-text-3" id="text-7-9">
</div><div id="outline-container-sec-7-9-1" class="outline-4">
<h4 id="sec-7-9-1">string-in-list-p</h4>
<div class="outline-text-4" id="text-7-9-1">
<p>
Test to see if a list contains a specified string.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">string-in-list-p</span> <span style="color: #BFEBBF;">(</span>string l<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>iterate <span style="color: #D0BF8F;">(</span>for s in l<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">when</span> <span style="color: #93E0E3;">(</span>string= s string<span style="color: #93E0E3;">)</span>
      l<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-9-2" class="outline-4">
<h4 id="sec-7-9-2">check-answer</h4>
<div class="outline-text-4" id="text-7-9-2">
<p>
Test a provided answer for correctness against data stored in a vocab-entry instance.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">check-answer</span> <span style="color: #BFEBBF;">(</span>answer vocab-entry test-type<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">cond</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>not <span style="color: #9FC59F;">(</span>member test-type '<span style="color: #94BFF3;">(</span>english hanzi pinyin<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
         <span style="color: #93E0E3;">(</span><span style="color: #D0BF8F; font-weight: bold;">error</span> <span style="color: #CC9393;">"Unknown test-type"</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
        <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>and <span style="color: #9FC59F;">(</span>equalp test-type 'english<span style="color: #9FC59F;">)</span>
              <span style="color: #9FC59F;">(</span>string-in-list-p answer <span style="color: #94BFF3;">(</span>vocab-entry-english vocab-entry<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
        <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>and <span style="color: #9FC59F;">(</span>equalp test-type 'hanzi<span style="color: #9FC59F;">)</span>
              <span style="color: #9FC59F;">(</span>string= answer <span style="color: #94BFF3;">(</span>vocab-entry-hanzi vocab-entry<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
        <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>and <span style="color: #9FC59F;">(</span>equalp test-type 'pinyin<span style="color: #9FC59F;">)</span>
              <span style="color: #9FC59F;">(</span>string= answer <span style="color: #94BFF3;">(</span>vocab-entry-pinyin vocab-entry<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-9-3" class="outline-4">
<h4 id="sec-7-9-3">score-result</h4>
<div class="outline-text-4" id="text-7-9-3">
<p>
Return a complex number, depending the state of <code>result</code>, that is added to the
score stored in a specific <code>vocab-entry</code> structure. The left side of the complex
is Correct, the right is Incorrect.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">score-result</span> <span style="color: #BFEBBF;">(</span>result<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> result
      1
      #C<span style="color: #D0BF8F;">(</span>0 1<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-9-4" class="outline-4">
<h4 id="sec-7-9-4">determine-offset</h4>
<div class="outline-text-4" id="text-7-9-4">
<p>
Determine the offset for scheduling from anywhere between minutes to weeks based
on the ratio between the real and imaginary components of the complex number
stored in the <code>:score</code> slot. This is used to grade understanding between at
least four categories: unknown, poorly known, somewhat known, and known.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">determine-offset</span> <span style="color: #BFEBBF;">(</span>c<span style="color: #BFEBBF;">)</span>
    <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>ratio <span style="color: #9FC59F;">(</span>/ <span style="color: #94BFF3;">(</span>realpart c<span style="color: #94BFF3;">)</span> <span style="color: #94BFF3;">(</span>imagpart c<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
      <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">cond</span> <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>&lt;= ratio 1<span style="color: #9FC59F;">)</span>  3600<span style="color: #93E0E3;">)</span>
            <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>&lt;= ratio 2<span style="color: #9FC59F;">)</span>  7200<span style="color: #93E0E3;">)</span>
            <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>&lt;= ratio 5<span style="color: #9FC59F;">)</span>  10800<span style="color: #93E0E3;">)</span>
            <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>&lt;= ratio 10<span style="color: #9FC59F;">)</span> 28000<span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-9-5" class="outline-4">
<h4 id="sec-7-9-5">schedule-next-test</h4>
<div class="outline-text-4" id="text-7-9-5">
<p>
Determine when a word should be tested next based on the number of repetitions,
and adjust this based on the score.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">schedule-next-test</span> <span style="color: #BFEBBF;">(</span>reps score<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span>round
   <span style="color: #D0BF8F;">(</span>+ <span style="color: #93E0E3;">(</span>get-universal-time<span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>* <span style="color: #9FC59F;">(</span>+ 7200
            <span style="color: #94BFF3;">(</span>determine-offset score<span style="color: #94BFF3;">)</span> 
            <span style="color: #94BFF3;">(</span>expt phi <span style="color: #E0CF9F;">(</span>/ reps 2<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-7-10" class="outline-3">
<h3 id="sec-7-10"><span class="section-number-3">7.10</span> display-and-play</h3>
<div class="outline-text-3" id="text-7-10">
<p>
Print the Challenge to the screen, then prompt the user for the selected test,
and play the sound file associated with the vocab entry. Update the score stored
in the vocab-entry structure to reflect the correctness of the answer.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">display-and-play</span> <span style="color: #BFEBBF;">(</span><span style="color: #7CB8BB;">&amp;key</span> key from for<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>goal      <span style="color: #9FC59F;">(</span>show-challenge <span style="color: #DCDCCC; font-weight: bold;">:field</span> for <span style="color: #DCDCCC; font-weight: bold;">:key</span> key<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
        <span style="color: #93E0E3;">(</span>challenge <span style="color: #9FC59F;">(</span>show-challenge <span style="color: #DCDCCC; font-weight: bold;">:field</span> from <span style="color: #DCDCCC; font-weight: bold;">:key</span> key<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>play-mp3 key<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>format t <span style="color: #CC9393;">"~D~%~D&gt; "</span> challenge for<span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span><span style="color: #F0DFAF; font-weight: bold;">let*</span> <span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span>vocab-entry <span style="color: #94BFF3;">(</span>gethash key *zh-hash-table*<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
           <span style="color: #9FC59F;">(</span>results     <span style="color: #94BFF3;">(</span><span style="color: #D0BF8F; font-weight: bold;">check-answer</span> <span style="color: #E0CF9F;">(</span>get-answer<span style="color: #E0CF9F;">)</span> vocab-entry for<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
           <span style="color: #9FC59F;">(</span>reps        <span style="color: #94BFF3;">(</span>vocab-entry-reps vocab-entry<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>setf <span style="color: #9FC59F;">(</span>vocab-entry-score vocab-entry<span style="color: #9FC59F;">)</span>
            <span style="color: #9FC59F;">(</span>+ <span style="color: #94BFF3;">(</span>score-result results<span style="color: #94BFF3;">)</span>
               <span style="color: #94BFF3;">(</span>vocab-entry-score vocab-entry<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> results
          <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">progn</span> <span style="color: #94BFF3;">(</span>setf <span style="color: #E0CF9F;">(</span>vocab-entry-date vocab-entry<span style="color: #E0CF9F;">)</span>
                       <span style="color: #E0CF9F;">(</span>schedule-next-test reps
                                           <span style="color: #8FB28F;">(</span>vocab-entry-score vocab-entry<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
                 <span style="color: #94BFF3;">(</span>incf reps<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
          <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">progn</span> <span style="color: #94BFF3;">(</span>setf *test-pool*
                       <span style="color: #E0CF9F;">(</span>reverse <span style="color: #8FB28F;">(</span>cons key <span style="color: #6CA0A3;">(</span>reverse *test-pool*<span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
                 goal<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
<ul class="org-ul"><li><a id="sec-7-10-0-1" name="sec-7-10-0-1"></a>get-answer<br  /><div class="outline-text-5" id="text-7-10-0-1">
<p>
Just having a call to <code>read-line</code> has some strange effects on program flow, so
I'm wrapping it in a function.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">get-answer</span> <span style="color: #BFEBBF;">()</span>
  <span style="color: #BFEBBF;">(</span>read-line<span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</li></ul>
</div>
<div id="outline-container-sec-7-11" class="outline-3">
<h3 id="sec-7-11"><span class="section-number-3">7.11</span> test-loop</h3>
<div class="outline-text-3" id="text-7-11">
<p>
Loop through a set of tests where the test type is indeterminate.
</p>
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">test-loop</span> <span style="color: #BFEBBF;">(</span><span style="color: #7CB8BB;">&amp;optional</span> <span style="color: #D0BF8F;">(</span>n 10<span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">(</span>type 'random<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>test-list <span style="color: #9FC59F;">(</span>construct-test-list n<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>iterate <span style="color: #93E0E3;">(</span>for elt in test-list<span style="color: #93E0E3;">)</span>
      <span style="color: #93E0E3;">(</span>for i from n downto 0<span style="color: #93E0E3;">)</span>

      <span style="color: #93E0E3;">(</span><span style="color: #F0DFAF; font-weight: bold;">case</span> type
        <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">(</span>random<span style="color: #94BFF3;">)</span> <span style="color: #94BFF3;">(</span>random-test elt<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span>
        <span style="color: #9FC59F;">(</span><span style="color: #94BFF3;">(</span>t<span style="color: #94BFF3;">)</span> <span style="color: #94BFF3;">(</span>display-and-play <span style="color: #DCDCCC; font-weight: bold;">:key</span> elt <span style="color: #DCDCCC; font-weight: bold;">:from</span> 'pinyin <span style="color: #DCDCCC; font-weight: bold;">:for</span> 'hanzi<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7-12" class="outline-3">
<h3 id="sec-7-12"><span class="section-number-3">7.12</span> random-test</h3>
<div class="outline-text-3" id="text-7-12">
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">defun</span> <span style="color: #93E0E3;">random-test</span> <span style="color: #BFEBBF;">(</span>key<span style="color: #BFEBBF;">)</span>
  <span style="color: #BFEBBF;">(</span><span style="color: #F0DFAF; font-weight: bold;">let*</span> <span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">(</span>test-list <span style="color: #9FC59F;">(</span>list 'hanzi 'pinyin 'english<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
         <span style="color: #93E0E3;">(</span>crazy-english <span style="color: #9FC59F;">(</span>list 'hanzi 'pinyin<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
         <span style="color: #93E0E3;">(</span>sane-for <span style="color: #9FC59F;">(</span><span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #94BFF3;">(</span>english-sensible-p <span style="color: #E0CF9F;">(</span>gethash key *zh-hash-table*<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>
                       <span style="color: #94BFF3;">(</span>nth <span style="color: #E0CF9F;">(</span>random <span style="color: #8FB28F;">(</span>length test-list<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span> test-list<span style="color: #94BFF3;">)</span>
                       <span style="color: #94BFF3;">(</span>nth <span style="color: #E0CF9F;">(</span>random <span style="color: #8FB28F;">(</span>length crazy-english<span style="color: #8FB28F;">)</span><span style="color: #E0CF9F;">)</span> crazy-english<span style="color: #94BFF3;">)</span><span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
         <span style="color: #93E0E3;">(</span>rest-tests <span style="color: #9FC59F;">(</span>delete sane-for test-list<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span>
         <span style="color: #93E0E3;">(</span>from <span style="color: #9FC59F;">(</span>nth <span style="color: #94BFF3;">(</span>random <span style="color: #E0CF9F;">(</span>length rest-tests<span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span> rest-tests<span style="color: #9FC59F;">)</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #D0BF8F;">(</span>display-and-play <span style="color: #DCDCCC; font-weight: bold;">:key</span> key <span style="color: #DCDCCC; font-weight: bold;">:from</span> from <span style="color: #DCDCCC; font-weight: bold;">:for</span> sane-for<span style="color: #D0BF8F;">)</span><span style="color: #BFEBBF;">)</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> User Interface</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> Header</h3>
<div class="outline-text-3" id="text-8-1">
<div class="org-src-container">

<pre class="src src-lisp"><span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">This is the source for the GUI front-end of the Chinese Vocab Drill</span>
<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">package. It uses GTK+ 3.x via CFFI.</span>
<span style="color: #DCDCCC;">(</span><span style="color: #F0DFAF; font-weight: bold;">in-package</span> <span style="color: #DCDCCC; font-weight: bold;">:cl-cvd</span><span style="color: #DCDCCC;">)</span>
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Riley E.</p>
<p class="date">Created: 2014-12-04 Thu 15:27</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
